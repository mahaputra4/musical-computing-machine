name: Server Workflows

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ROOT_PASS: ${{ secrets.ROOT_PASS }}
      ZROK_ENV: ${{ secrets.ZROK_ENV }}

    steps:
    - name: Set up dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg xrdp curl p7zip-full expect

    - name: Download zrok
      run: |
        wget https://github.com/openziti/zrok/releases/download/v0.4.24/zrok_0.4.24_linux_amd64.tar.gz -O zrok.tar.gz

    - name: Install zrok
      run: |
        mkdir ./zrok && tar -xf ./zrok.tar.gz -C ./zrok
        ./zrok/zrok version

    - name: Configure Remote Desktop and Change Root Password
      run: |
        echo "root:$ROOT_PASS" | sudo chpasswd
        sudo systemctl enable xrdp
        sudo systemctl start xrdp
        sudo ufw allow 3389/tcp

    - name: Folder Check
      run: |
        ls
        pwd

    - name: Tunnel Setup with zrok
      run: |
        # Create an expect script
        echo '#!/usr/bin/expect -f' > zrok_setup.exp
        echo "spawn bash -c \"zrok enable '$ZROK_ENV' && zrok share private --backend-mode tcpTunnel 127.0.0.1:3389\"" >> zrok_setup.exp
        echo 'expect eof' >> zrok_setup.exp

        chmod +x zrok_setup.exp  # Make the script executable
        ./zrok_setup.exp  # Run the expect script
